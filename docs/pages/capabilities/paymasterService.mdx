# `paymasterService` Capability

:::warning
This capability is not yet confirmed, but is provided for illustrative purposes.
:::

A capability for apps to communicate with wallets about ERC-4337 paymaster web services.

Defined in [ERC-7677](https://eips.ethereum.org/EIPS/eip-7677).

## Specification

### App

If you want to sponsor your users' transactions, you can do so by passing paymaster service URLs along with `wallet_sendCalls` requests. You'll need to include a `paymasterService` object in `capabilities` that maps chain IDs to paymaster service configurations.

For each chain, you can specify:
- `url`: The paymaster service URL for that chain
- `context`: Additional data defined by the paymaster service provider

#### Example

```ts twoslash
// @noErrors
provider.request({
  method: 'wallet_sendCalls',
  params: [{
    version: '1.0',
    chainId: '0x01',
    from: '0xd46e8dd67c5d32be8058bb8eb970870f07244567',
    calls: [
      {
        to: '0xd46e8dd67c5d32be8058bb8eb970870f07244567',
        value: '0x9184e72a',
        data: '0xd46e8dd67c5d32be8d46e8dd67c5d32be8058bb8eb970870f072445675058bb8eb970870f072445675'
      }
    ],
    capabilities: {
      paymasterService: {
        "0x01": {
          url: "https://paymaster.example.com",
          context: {
            // Illustrative context field. These should be defined by service providers.
            policyId: "962b252c-a726-4a37-8d86-333ce0a07299"
          }
        }
      }
    }
  }]
})
```

:::warning
For security, consider proxying paymaster service calls through your backend to protect API keys.
:::

### Wallet

To support the `paymasterService` capability, a wallet must:

1. Indicate support in `wallet_getCapabilities` responses
2. Communicate with paymaster services according to ERC-7677 when handling `wallet_sendCalls` requests

#### `wallet_getCapabilities` Behavior

Wallets should indicate paymaster service support per chain in their capabilities response:

```ts twoslash
// @noErrors
provider.request({
  method: 'wallet_getCapabilities',
  params: ['0xd46e8dd67c5d32be8058bb8eb970870f07244567']
})
// @log: {
// @log:   "0x2105": {
// @log:     "paymasterService": {
// @log:       "supported": true
// @log:     }
// @log:   }
// @log: }
```

#### `wallet_sendCalls` Behavior

When processing a `wallet_sendCalls` request with a `paymasterService` capability, wallets need to:

1. Call `pm_getPaymasterStubData` to get stub values for gas estimation
   - This returns paymaster fields and optional sponsor info
   - May include gas estimates specific to the paymaster
   - May indicate if `pm_getPaymasterData` can be skipped

2. Call `pm_getPaymasterData` to get final paymaster values (unless skipped)
   - This provides the actual paymaster fields to use in the user operation

The wallet must detect which entrypoint version is being used and handle the appropriate paymaster fields (e.g., `paymasterAndData` for v0.6 or separate `paymaster`/`paymasterData` for v0.7).

:::note
Wallets may allow users to select different paymasters than those provided by apps. Applications should not assume their specified paymaster will be used.
:::